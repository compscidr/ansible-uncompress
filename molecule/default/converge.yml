---
- name: Converge
  hosts: all
  become: true
  tasks:
    - name: Test uncompress with .gz file (no copy)
      compscidr.uncompress.uncompress:
        copy: false
        src: https://github.com/cheat/cheat/releases/download/4.3.1/cheat-linux-amd64.gz
        dest: /tmp/cheat
        mode: '755'
      register: result_cheat

    - name: Create a test .gz file
      ansible.builtin.shell: |
        echo "test content for gz" > /tmp/test.txt
        gzip -f /tmp/test.txt
      args:
        creates: /tmp/test.txt.gz

    - name: Test uncompress with local .gz file (with copy)
      compscidr.uncompress.uncompress:
        copy: true
        src: /tmp/test.txt.gz
        dest: /tmp/test-uncompressed.txt
        mode: '644'
      register: result_gz

    - name: Create a test .bz2 file
      ansible.builtin.shell: |
        echo "test content for bz2" > /tmp/test2.txt
        bzip2 -f /tmp/test2.txt
      args:
        creates: /tmp/test2.txt.bz2

    - name: Test uncompress with .bz2 file
      compscidr.uncompress.uncompress:
        copy: true
        src: /tmp/test2.txt.bz2
        dest: /tmp/test2-uncompressed.txt
        mode: '644'
      register: result_bz2

    - name: Create directory for testing directory dest
      ansible.builtin.file:
        path: /tmp/uncompress-test-dir
        state: directory
        mode: '755'

    - name: Create a test .gz file for directory dest
      ansible.builtin.shell: |
        echo "test content for gz directory" > /tmp/test3.txt
        gzip -f /tmp/test3.txt
      args:
        creates: /tmp/test3.txt.gz

    - name: Test uncompress with .gz file to directory
      compscidr.uncompress.uncompress:
        copy: true
        src: /tmp/test3.txt.gz
        dest: /tmp/uncompress-test-dir/
        mode: '644'
      register: result_gz_dir

    - name: Create a test .bz2 file for directory dest
      ansible.builtin.shell: |
        echo "test content for bz2 directory" > /tmp/test4.txt
        bzip2 -f /tmp/test4.txt
      args:
        creates: /tmp/test4.txt.bz2

    - name: Test uncompress with .bz2 file to directory
      compscidr.uncompress.uncompress:
        copy: true
        src: /tmp/test4.txt.bz2
        dest: /tmp/uncompress-test-dir/
        mode: '644'
      register: result_bz2_dir

    - name: Create a test .tar.gz file for directory dest
      ansible.builtin.shell: |
        echo "test content for tar.gz" > /tmp/test5.txt
        tar -czf /tmp/test5.tar.gz -C /tmp test5.txt
      args:
        creates: /tmp/test5.tar.gz

    - name: Test uncompress with .tar.gz file to directory (should result in .tar)
      compscidr.uncompress.uncompress:
        copy: true
        src: /tmp/test5.tar.gz
        dest: /tmp/uncompress-test-dir/
        mode: '644'
      register: result_tar_gz_dir
